.. _best-practices:

****************
 Best Practices
****************

General Tips for the Trial Definition
=====================================

Do:

-  Use framework abstractions to implement learning rate scheduling instead of directly changing the
   learning rate. See `tf.keras.optimizers.schedules.LearningRateSchedule
   <https://www.tensorflow.org/api_docs/python/tf/keras/optimizers/schedules/LearningRateSchedule>`__
   and :class:`determined.pytorch.LRScheduler` as examples.

-  For code that needs to download artifacts (e.g., data, configurations, pretrained weights),
   download to a `tempfile.TemporaryDirectory <https://docs.python.org/3/library/tempfile.html>`__
   unique to the Python process. This will avoid race conditions when using :ref:`distributed
   training <multi-gpu-training>`, in which Determined executes multiple Python processes in the
   same task container.

Do not:

-  Use instance attributes on a trial class to save any state over time (e.g., storing metric
   history in a ``self`` attribute). The ``Trial`` instance will only save and restore model weights
   and optimizer state over time; ``self`` attributes may be reset to their initial state at any
   time if the Determined cluster reschedules the trial to another task container.

Separate Configuration from Code
================================

We encourage a clean separation of code from configuration via the :ref:`experiment configuration
<experiment-configuration>`. Specifically, you are encouraged to use the pre-defined fields in the
experiment configuration, such as the ``searcher``, ``hyperparameters``, ``optimizations``, and
``resources``. This not only allows you to reuse the trial definition when you tune different
configuration fields but also improve the visualibility because those fields can be browsed in our
WebUI.

Do:

-  Move any hardcoded scalar values to the :ref:`hyperparameters
   <experiment-configuration_hyperparameters>` or :ref:`data <experiment-config-data>` fields in the
   experiment configuration. Use :func:`context.get_hparam() <determined.TrialContext.get_hparam>`
   or :func:`context.get_data_config() <determined.TrialContext.get_data_config>` to reference them
   in code.

-  Move any hardcoded filesystem paths (e.g., ``/data/train.csv``) to the ``data`` field of the
   experiment configuration. Use ``context.get_data_config()`` to reference them in code.

Do not:

-  Use global variables in your model definition; consider moving them to the experiment
   configuration.

Understand Dependencies
=======================

We encourage tracking the dependencies associated with every workflow via the :ref:`environment
<experiment-configuration>` field. Understanding and standardizing the environment you use to
execute Python in your development environment will pay off dividends in **portability**, allowing
you to flexibly move between local, cloud, and on-premise cluster environments.

Do:

-  Ramp up quickly by using our :ref:`default environment Docker image <default-environment>`,
   optionally specifying additional PyPI dependencies by using ``pip install`` in
   ``startup-hook.sh``.

-  As your dependencies increase in complexity, invest in :ref:`building and using a custom Docker
   image <custom-env>` that meets your needs.

-  Pin Python package dependencies to specific versions (e.g., ``<package>==<version>``) in build
   tools.

Do not:

-  Modify the ``PYTHONPATH`` or ``PATH`` environment variables to import libraries by circumventing
   the Python packaging system.

*********
 Support
*********

TensorFlow
==========

TensorFlow Core Models
----------------------

Determined has support for TensorFlow models that use the :doc:`/training-apis/api-keras` or
:doc:`/training-apis/api-estimator` APIs. For models that use the low-level TensorFlow Core APIs, we
recommend porting your model to use :doc:`/training-apis/api-estimator`. `Example of converting a
TensorFlow graph into an Estimator
<https://github.com/determined-ai/determined/blob/master/examples/computer_vision/mnist_tf_layers/model_def.py>`_.

TensorFlow 1 vs 2
-----------------

Determined supports both TensorFlow 1 and 2. The version of TensorFlow that is used for a particular
experiment is controlled by the container image that has been configured for that experiment.
Determined provides prebuilt Docker images that include TensorFlow 2.4, 1.15, 2.5, and 2.6,
respectively:

-  ``determinedai/environments:cuda-11.1-pytorch-1.9-lightning-1.3-tf-2.4-gpu-0.17.2`` (default)
-  ``determinedai/environments:cuda-10.2-pytorch-1.7-tf-1.15-gpu-0.17.2``
-  ``determinedai/environments:cuda-11.2-tf-2.5-gpu-0.17.2``
-  ``determinedai/environments:cuda-11.2-tf-2.6-gpu-0.17.2``

We also provide lightweight CPU-only counterparts:

-  ``determinedai/environments:py-3.8-pytorch-1.9-lightning-1.3-tf-2.4-cpu-0.17.2``
-  ``determinedai/environments:py-3.7-pytorch-1.7-tf-1.15-cpu-0.17.2``
-  ``determinedai/environments:py-3.8-tf-2.5-cpu-0.17.2``
-  ``determinedai/environments:py-3.8-tf-2.6-cpu-0.17.2``

To change the container image used for an experiment, specify :ref:`environment.image
<exp-environment-image>` in the experiment configuration file. Please see :ref:`container-images`
for more details about configuring training environments and a more complete list of prebuilt Docker
images.